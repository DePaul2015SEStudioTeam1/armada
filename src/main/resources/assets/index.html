
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Armada Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">

<link href="css/bootstrap.min.css" rel="stylesheet">
<style>
body {
	padding-top: 0px;
	/* 0px to make the container go all the way to the bottom of the topbar */
	/*font-size: 70%;*/
}
</style>
<link href="css/bootstrap-responsive.css" rel="stylesheet">
<link href="css/styles.css" rel="stylesheet">
<link href="css/dataTables.bootstrap.css" rel="stylesheet">
<link href="css/dataTables.tableTools.css" rel="stylesheet">

<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

</head>
<html>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/jquery.dataTables.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/dataTables.bootstrap.js"></script>
<script type="text/javascript" src="js/dataTables.tableTools.js"></script>
<script type="text/javascript" src="js/Chart.js"></script>
<script>
	var cpuThreshold;
	var diskThreshold;
	var memoryThreshold;
	var refreshVar;
	var tableRefresh;
		
	$(function() {
		var preferencesREST = "http://localhost:8083/preferences/";
		$.get(preferencesREST).done(function( data ) {
			$.each( data, function( id ) {
			
				if (data[id].name == 'cpu_threshold') {
					cpuThreshold = data[id].value;
				} else if (data[id].name == 'disk_threshold') {
	            	diskThreshold = data[id].value;   
				} else if (data[id].name == 'memory_threshold') {
			    	memoryThreshold = data[id].value;
				} else if (data[id].name == 'refresh_page') {
					refreshVar = data[id].value;
					tableRefresh = refreshVar * 1000;
				}
			});
		});
	});
</script>
<body>
	<nav class="navbar navbar-inverse navbar-static-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<img src="images/ship.gif" alt="ship"
					style="width: 50px; height: 50px"> <a class="navbar-brand"
					href="#">Welcome to Armada</a>
			</div>
		</div>
	</nav>

	<div class="container">
		<div class="text-right">
			<!-- add an icon here, a gear -->
			<a href="#settings" data-toggle="modal" data-target="#settings">Settings</a>
			<br /> Today is
			<script>document.write(new Date().toDateString()); </script>
		</div>
		<div class="modal fade bannerformmodal" tabindex="-1" role="dialog"
			aria-labelledby="bannerformmodal" aria-hidden="true" id="settings">
			<div class="modal-dialog modal-sm">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"
							aria-hidden="true">&times;</button>
						<h4 class="modal-title" id="myModalLabel">Settings</h4>
					</div>
					<div class="modal-body">
						<form id="settingsForm" method="POST">
							<div class="form-group">
								<div class="input-group spinner">
								<label class="control-label" for="textinput">CPU Threshold</label>
									<input id="cpu_threshold" type="number" class="form-control" name="cpu_threshold" data-min="0" data-max="100"/>
								</div>
							</div>
							<div class="form-group">
								<div class="input-group spinner">
								<label class="control-label" for="textinput">Memory Threshold</label>
									<input id="memory_threshold" type="number" class="form-control" name="memory_threshold" data-min="0" data-max="100"/>
								</div>
							</div>
							<div class="form-group">
								<div class="input-group spinner">
								<label class="control-label" for="textinput">Disk Threshold</label>
										<input id="disk_threshold" type="number" class="form-control" name="disk_threshold" data-min="0" data-max="100"/>
								</div>
							</div>
							<div class="form-group">
								<div class="input-group spinner">
								<label class="control-label" for="textinput">Table Refresh</label>
										<input id="refresh_page" type="number" class="form-control" name="refresh_page" data-min="0" />
								</div>
							</div>
							<div align="right">
								<button id="saveSettings" type="submit" class="btn btn-blue btn-primary" data-dismiss="modal">Save</button>
								<button type="button" class="btn btn-blue" id="resetbtn">Reset</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

		<div class="panel panel-default col-xs-6">
			<div class="panel-body">
					<div class="col-xs-6">
						<div class="row">
							<div class="col-xs-3 label label-default label-success"><h5>Running: 5</h5></div>
						</div>
						<div class="row">
							<div class="col-xs-3 label label-warning"><h5>Idle: 1</h5></div>
						</div>
						<div class="row">
							<div class="col-xs-3 label label-danger"><h5>Error: 2</h5></div>
						</div>
					</div>
					<div class="col-xs-4">
						<canvas id="myChart3" width="200" height="200"></canvas>
					</div>
			</div>
		</div>
		<br />
		<div>
			<legend>Container Activity</legend>
			<div class="row-fluid table-condensed">
				<table id="containers" class="table table-hover table-bordered"
					cellspacing="0" width="100%">
					<thead>
						<tr>
							<th>Name</th>
							<th>Container Id</th>
							<th>C Advisor URL</th>
							<th>CPU Used</th>
							<th>CPU Total</th>
							<th>Mem Used</th>
							<th>Mem Total</th>
							<th>Disk Used</th>
							<th>Disk Total</th>
						</tr>
					</thead>
				</table>
			</div>
		</div>
	</div>
	<div class="modal fade bannerformmodal" tabindex="-1" role="dialog" aria-labelledby="bannerformmodal" aria-hidden="true" id="cDetails">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				</div>
				<div class="modal-body">
<!--						<canvas id="myChart" width="200" height="200"></canvas>-->
<!--						<canvas id="myChart2" width="200" height="200"></canvas>-->
<!--						<canvas id="myChart4" width="200" height="200"></canvas>-->
				</div>
			</div>
		</div>
	</div>

	<script>
	$(document).ready(function() {
		var cName;
		var memArray = new Array();
		var diskArray = new Array();
		var cpuArray = new Array();
		var timestampArray = new Array();
		
		var cpuData = {
			labels: timestampArray,
			datasets: [
				{
					label: "CPU Usage History",
					fillColor: "rgba(220,220,220,0.2)",
					strokeColor: "rgba(220,220,220,1)",
					pointColor: "rgba(220,220,220,1)",
					pointStrokeColor: "#fff",
					pointHighlightFill: "#fff",
					pointHighlightStroke: "rgba(220,220,220,1)",
					data: cpuArray
				}
			]
		};

		var memData = {
			labels: timestampArray,
			datasets: [
				{
					label: "Memory Usage History",
					fillColor: "rgba(220,220,220,0.2)",
					strokeColor: "rgba(220,220,220,1)",
					pointColor: "rgba(220,220,220,1)",
					pointStrokeColor: "#fff",
					pointHighlightFill: "#fff",
					pointHighlightStroke: "rgba(220,220,220,1)",
					data: memArray
				}
			]
		};
		
		var diskData = {
			labels: timestampArray,
			datasets: [
				{
					label: "Disk History",
					fillColor: "rgba(220,220,220,0.2)",
					strokeColor: "rgba(220,220,220,1)",
					pointColor: "rgba(220,220,220,1)",
					pointStrokeColor: "#fff",
					pointHighlightFill: "#fff",
					pointHighlightStroke: "rgba(220,220,220,1)",
					data: diskArray
				}
			]
		};
		
		var data3 = [
			{
				value: 3,
				color:"#F7464A",
				highlight: "#F7464A",
				label: "Inactive"
			},
			{
				value: 5,
				color: "#5cb85c",
				highlight: "#5cb85c",
				label: "Active"
			},
			{
				value: 1,
				color: "#f0ad4e",
				highlight: "#f0ad4e",
				label: "Active"
			}		
		];

		var ctx3 = document.getElementById("myChart3").getContext("2d");		
		var myPieChart = new Chart(ctx3).Pie(data3);
	
		var table = $('#containers').DataTable( {
			"cache": false,
			"white-space": "nowrap",
			"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
	    	"ajax": {
	   			url: "http://localhost:8083/containers/",
	   			dataSrc: ""
	    	},
			"columns": [
				{ "data": "name" },
				{ "data": "containerUniqueId" },
				{ "data": "cAdvisorURL" },
				{ "data": "cpuUsed" },
				{ "data": "cpuTotal" },
				{ "data": "memUsed" },
				{ "data": "memTotal" },
				{ "data": "diskUsed" },
				{ "data": "diskTotal" },
				{ "data": "containerId"}
			],
			"columnDefs": [
	            {
	                "targets": [9],
	                "visible": false,
	                "searchable": false
	            }
			],
			"fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
				$(nRow).children().each(function(index, td) {
                    if(aData.cpuUsed >= cpuThreshold)  {
                    	$(nRow).css('background', '#F7464A')
                    } else if (aData.diskUsed >= diskThreshold) {
                    	$(nRow).css('background', '#F7464A')
                    } else if (aData.memUsed >= memoryThreshold) {
                    	$(nRow).css('background', '#F7464A')
                    }
		        });             
		    }
		} );
		$.fn.dataTable.ext.errMode = 'throw';

		setInterval( function () {
			table.ajax.reload( null, false ); // user paging is not reset on reload
		}, 40000);

		$('#containers tbody tr').each( function() {
	        var title;
	        var tds = $('td', this);
	        var cpuUsed = $(tds[3]).text();
	        var memUsed = $(tds[5]).text();
	        var diskUsed = $(tds[7]).text();
	         
            if(cpuUsed >= cpuThreshold)  {
				title = " CPU Used > " + cpuThreshold;
            } else if (diskUsed >= diskThreshold) {
            	title += " Disk Used > " + diskUsed;
            } else if (memUsed >= memoryThreshold) {
            	title += " Memory Used > " + memUsed;
            }
	         
	        this.setAttribute( 'title', title );
	    } );

		table.$('tr').tooltip( {
	        "delay": 0,
	        "track": true,
	        "fade": 250
	    } );

		$('#containers tbody').on( 'dblclick', 'tr', function () {
			cName = table.cell(this, 0).data();
			var cId = table.cell(this,9).data();
			
			var logsREST = "http://localhost:8083/logs/"+cId;
    		$.get(logsREST).done(function( data ) {
    			$.each( data, function( id ) {
					memArray.push(data[id].memUsed);
					diskArray.push(data[id].diskUsed);
					cpuArray.push(data[id].cpuUsed);
					timestampArray.push(data[id].timestamp);
        		});
    		});
			
	        $('#cDetails').modal('show');
	    });

	    $('#cDetails').bind('show', function() {
	    	$(".modal-header").html("<button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-hidden=\"true\">&times;</button><h4>" + cName + " - Details</h4>");
<!--	    	$('#cDetails').find('.modal-body').append("<canvas id=\"myChart\" width=\"200\" height=\"200\"></canvas><canvas id=\"myChart2\" width=\"200\" height=\"200\"></canvas><canvas id=\"myChart4\" width=\"200\" height=\"200\"></canvas>");-->
	    	$('#cDetails').find('.modal-body').append("<canvas id=\"myChart\" width=\"400\" height=\"400\"></canvas>");

	    	var ctx = document.getElementById("myChart").getContext("2d");
			var myCpuChart = new Chart(ctx).Line(cpuData);
			
<!--			var ctx2 = document.getElementById("myChart2").getContext("2d");-->
<!--			var myDiskChart = new Chart(ctx2).Line(diskData);-->
<!---->
<!--			var ctx4 = document.getElementById("myChart4").getContext("2d");		-->
<!--			var myMemoryChart = new Chart(ctx4).Line(memData);-->
		});

		 $('#settings').bind('show',function() {
             $(".modal-body #memory_threshold").val(memoryThreshold);
             $(".modal-body #cpu_threshold").val(cpuThreshold);
             $(".modal-body #disk_threshold").val(diskThreshold);
             $(".modal-body #refresh_page").val(refreshVar);
         });

		 $("#saveSettings").click(function(e){
			e.preventDefault();
			console.log(JSON.stringify($('#settingsForm').serializeArray()))
			$.ajax({
	            type: "POST",
	            url: "http://localhost:8083/preferences/setAll/",
	            data: JSON.stringify($('#settingsForm').serializeArray()),
	            dataType: 'json',
	            contentType: 'application/json; charset=utf-8',
	            error: function(e) {
	                console.log(e);
	            }
			});
			location.reload();
         });

	} );
</script>

</body>
</html>
